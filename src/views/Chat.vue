<template>
    <n-config-provider :theme="darkTheme">
        <div class="chat-container">
            <!-- Â∑¶‰æß‰ºöËØùÂàóË°® -->
            <n-layout-sider bordered content-style="padding: 0;" class="chat-sidebar" style="height: 100dvh;">
                <div class="sidebar-header">
                    <span class="sidebar-title">‰ºöËØùÂàóË°®</span>
                    <n-button quaternary circle @click="prepareNewConversation">
                        <template #icon>
                            <n-icon><add-outline /></n-icon>
                        </template>
                    </n-button>
                </div>

                <div class="conversation-list">
                    <template v-if="loading">
                        <div class="loading-container">
                            <n-spin size="small" />
                            <span>Âä†ËΩΩ‰∏≠...</span>
                        </div>
                    </template>

                    <template v-else-if="conversations.length > 0">
                        <div v-for="conv in conversations" :key="conv.id"
                            :class="['conversation-item', activeConversationId === conv.id ? 'active' : '']"
                            @click="switchConversation(conv.id)">
                            <n-space justify="space-between" align="left" style="width: 100%;">
                                <div
                                    style="flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; width: 100%;">
                                    <div class="conversation-title" :title="conv.originalTitle">
                                        <n-space align="left" :wrap="false" size="small"
                                            style="width: 100%; min-width: 0;">
                                            <n-icon style="flex-shrink: 0;"><chatbubble-outline /></n-icon>
                                            <n-icon v-if="conv.isFavorite" color="#f39c12" style="flex-shrink: 0;">
                                                <star />
                                            </n-icon>
                                            <span
                                                style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;">{{
                                                    conv.title }}</span>
                                        </n-space>
                                    </div>
                                    <div class="conversation-time">
                                        <n-time :time="conv.time" format="MM-dd HH:mm" />
                                    </div>
                                </div>

                                <n-space :size="0" :wrap="false">
                                    <n-popconfirm @positive-click="deleteConversation(conv.id)" positive-text="Á°ÆËÆ§" negative-text="ÂèñÊ∂à">
                                        <template #trigger>
                                            <n-button quaternary circle size="tiny" style="margin: 0;">
                                                <template #icon>
                                                    <n-icon size="12"><trash-outline/></n-icon>
                                                </template>
                                            </n-button>
                                        </template>
                                        Á°ÆÂÆöË¶ÅÂà†Èô§‰ºöËØù "{{ conv.originalTitle }}" ÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊí§ÈîÄ„ÄÇ
                                    </n-popconfirm>
                                    <!-- <n-dropdown :options="conversationOptions"
                                        @select="(key) => handleConversationAction(key, conv.id)">
                                        <n-button quaternary circle size="small">
                                            <template #icon>
                                                <n-icon><ellipsis-horizontal-outline /></n-icon>
                                            </template>
                                        </n-button>
                                    </n-dropdown> -->
                                </n-space>
                            </n-space>
                        </div>
                    </template>
                    <n-empty :show-icon="false" v-else description="ÊöÇÊó†‰ºöËØù" />
                </div>
            </n-layout-sider>

            <!-- ‰∏ªËÅäÂ§©Âå∫Âüü -->
            <n-layout class="chat-main">
                <!-- ËÅäÂ§©Â§¥ÈÉ® -->
                <n-layout-header bordered class="chat-header">
                    <div class="chat-title">
                        {{activeConversationId ? conversations.find(conv => conv.id === activeConversationId)?.title ||
                            'AIËÅäÂ§©' :
                            'AIËÅäÂ§©'}}
                    </div>
                    <n-space>
                        <n-button @click="goToConfig" type="primary" secondary v-if="isAdmin">
                            <template #icon>
                                <n-icon><settings-outline /></n-icon>
                            </template>
                            ËÆæÁΩÆ
                        </n-button>
                        <n-button @click="logout" type="error" secondary>
                            <template #icon>
                                <n-icon><log-out-outline /></n-icon>
                            </template>
                            ÈÄÄÂá∫ÁôªÂΩï
                        </n-button>
                    </n-space>
                </n-layout-header>

                <!-- ËÅäÂ§©Ê∂àÊÅØÂå∫Âüü -->
                <n-layout-content ref="chatContentRef" class="chat-messages">
                    <template v-if="messages.length > 0">
                        <div v-for="msg in messages" :key="msg.id"
                            :class="['message', msg.sender === username ? 'user-message' : 'ai-message']">
                            <div class="message-bubble">
                                <div class="message-header">
                                    <span class="sender">{{ msg.sender }}</span>
                                    <span class="time">{{ msg.time }}</span>

                                </div>
                                <div class="message-content markdown-body" v-html="formatMessageContent(msg.content)">
                                </div>
                                <div v-if="msg.isStreaming && !msg.content" class="typing-indicator">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                        <div class="bottom-spacer-static"></div>
                    </template>
                    <n-empty :show-icon="false" class="empty-conversations" v-else description="üòäÊÇ®Â•ΩÔºåËØ∑ÈóÆÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÔºü" />
                </n-layout-content>

                <!-- Â∫ïÈÉ®ËæìÂÖ•Âå∫Âüü -->
                <n-layout-footer bordered class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <n-input v-model:value="newMessage" type="textarea" round placeholder="ËæìÂÖ•Ê∂àÊÅØ..."
                            @keyup.enter="!isGenerating ? sendMessage() : null" class="chat-input" :autosize="{ minRows: 1, maxRows: 3 }" />
                        <n-button type="primary" secondary circle class="send-button" 
                                  @click="isGenerating ? stopGeneration() : sendMessage()">
                            <template #icon>
                                <n-icon>
                                    <send-outline v-if="!isGenerating" />
                                    <stop-outline v-else />
                                </n-icon>
                            </template>
                        </n-button>
                    </div>
                </n-layout-footer>
            </n-layout>
        </div>
    </n-config-provider>
</template>

<script setup>
import { userApi, chatApi, sessionApi, messageApi, configApi } from '../api';
import { ref, onMounted, nextTick, watch } from 'vue';
import { useRouter } from 'vue-router';
import { useMessage, useDialog, darkTheme } from 'naive-ui';
import { h } from 'vue';
import {
    NConfigProvider,
    NLayout,
    NLayoutSider,
    NLayoutHeader,
    NLayoutContent,
    NLayoutFooter,
    NButton,
    NInput,
    NTime,
    NSpace,
    NIcon,
    NDropdown,
    NEmpty,
    NSpin,
    NPopconfirm
} from 'naive-ui';
import {
    ChatbubbleOutline,
    AddOutline,
    SendOutline,
    LogOutOutline,
    EllipsisHorizontalOutline,
    TrashOutline,
    CreateOutline,
    Star,
    StopOutline,
    SettingsOutline
} from '@vicons/ionicons5';

import { Marked } from 'marked';
import hljs from 'highlight.js';
import { markedHighlight } from "marked-highlight";

// ÂºïÂÖ•Áã¨Á´ãÁöÑCSSÊñá‰ª∂
import '../assets/css/chat.css';
import 'github-markdown-css/github-markdown.css';
import 'highlight.js/styles/monokai-sublime.css';

const router = useRouter();
const message = useMessage();
const dialog = useDialog();
const messages = ref([]);
const newMessage = ref('');
const username = ref('Áî®Êà∑');
const activeConversationId = ref(null);
const isAdmin = ref(false);

// ‰ºöËØùÂàóË°®Êï∞ÊçÆ
const conversations = ref([]);
const loading = ref(false);

// AIÁîüÊàêÁä∂ÊÄÅÊéßÂà∂
const isGenerating = ref(false);
const currentEventSource = ref(null);
const currentStreamSessionId = ref(null);

const chatContentRef = ref(null);
// Êà™Êñ≠Ê†áÈ¢òÂà∞ÊúÄÈïø11‰∏™Â≠óÁ¨¶
const truncateTitle = (title) => {
    if (!title) return 'Êñ∞‰ºöËØù';
    return title.length > 10 ? title.substring(0, 10) + '...' : title;
};

// Êà™Êñ≠ÊëòË¶ÅÂà∞ÊúÄÈïø20‰∏™Â≠óÁ¨¶
const truncateSummary = (summary) => {
    if (!summary) return 'Êó†Ê∂àÊÅØ';
    return summary.length > 20 ? summary.substring(0, 20) + '...' : summary;
};

// Âä†ËΩΩ‰ºöËØùÂàóË°®
const loadConversations = async () => {
    try {
        loading.value = true;
        const response = await sessionApi.selectSessions();
        if (response.code === 200) {
            conversations.value = response.data.map(session => ({
                id: session.id,
                title: truncateTitle(session.title),
                lastMessage: truncateSummary(session.summary),
                time: new Date(session.lastMessageTime || session.createdTime),
                messages: [],
                originalTitle: session.title, // ‰øùÂ≠òÂéüÂßãÊ†áÈ¢òÁî®‰∫éÊòæÁ§∫ÂÆåÊï¥‰ø°ÊÅØ
                originalSummary: session.summary, // ‰øùÂ≠òÂéüÂßãÊëòË¶Å
                isFavorite: session.isFavorite,
                tags: session.tags
            }));
        } else {
            message.error(`Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        message.error(`Âä†ËΩΩ‰ºöËØùÂ§±Ë¥•: ${error.message}`);
    } finally {
        loading.value = false;
    }
};

// Ëá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
const scrollToBottom = async () => {
    await nextTick(); // Á≠âÂæÖDOMÊõ¥Êñ∞ÂÆåÊàê
    const layoutInst = chatContentRef.value;
    if (layoutInst) {
        const scrollContainer = layoutInst.$el; // .n-layout-scroll-container
        if (scrollContainer) {
            // Êü•ÊâæÂÆûÈôÖÁöÑÊªöÂä®Â≠êÂÆπÂô®
            const actualScrollContainer = scrollContainer.querySelector('.n-scrollbar-container') ||
                scrollContainer.querySelector('.n-layout-scroll-container') ||
                scrollContainer.querySelector('[class*="scroll"]') ||
                scrollContainer.firstElementChild;
            console.log('Actual scroll container:', actualScrollContainer);
            if (actualScrollContainer) {
                actualScrollContainer.scrollTo({
                    top: actualScrollContainer.scrollHeight,
                    behavior: 'smooth'
                });
            }
        }
    }
};

// ÁõëÂê¨Ê∂àÊÅØÂèòÂåñÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
watch(messages, () => {
    scrollToBottom();
}, { deep: true });

// ÁªÑ‰ª∂ÊåÇËΩΩÊó∂Âä†ËΩΩ‰ºöËØùÂàóË°®
onMounted(async () => {
    // ÈÖçÁΩÆmarked‰ΩøÁî®highlight.jsËøõË°å‰ª£Á†ÅÈ´ò‰∫Æ
    loadConversations();
    
    // Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÔºåÊ£ÄÊü•ÊòØÂê¶‰∏∫ÁÆ°ÁêÜÂëò
    try {
        const response = await userApi.getUserInfo();
        if (response.code === 200) {
            username.value = response.data.username || 'Áî®Êà∑';
            isAdmin.value = response.data.role === 1; // role=1‰∏∫ÁÆ°ÁêÜÂëò
        }
    } catch (error) {
        console.error('Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂ§±Ë¥•:', error);
    }
});

// ÂàáÊç¢‰ºöËØù
const switchConversation = async (convId) => {
    // ‰øùÂ≠òÂΩìÂâç‰ºöËØùÁöÑÊ∂àÊÅØ
    const currentConv = conversations.value.find(conv => conv.id === activeConversationId.value);
    if (currentConv) {
        currentConv.messages = [...messages.value];
    }

    // ÂàáÊç¢Âà∞Êñ∞‰ºöËØù
    activeConversationId.value = convId;

    // ‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩ‰ºöËØùÁöÑÂéÜÂè≤Ê∂àÊÅØ
    try {
        // console.log('Ê≠£Âú®Âä†ËΩΩ‰ºöËØùÂéÜÂè≤Ê∂àÊÅØÔºå‰ºöËØùID:', convId);
        const response = await messageApi.getMessagesBySessionId(convId);
        // console.log('ÂéÜÂè≤Ê∂àÊÅØAPIÂìçÂ∫î:', response);

        if (response.code === 200) {
            // console.log('ÂéÜÂè≤Ê∂àÊÅØÊï∞ÊçÆ:', response.data);

            // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶‰∏∫Á©∫
            if (!response.data || response.data.length === 0) {
                console.log('ËØ•‰ºöËØùÊöÇÊó†ÂéÜÂè≤Ê∂àÊÅØ');
                messages.value = [];
                return;
            }

            // ÂÖàÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÊ∂àÊÅØÂØπ
            const sortedData = response.data.sort((a, b) => new Date(a.createTime) - new Date(b.createTime));

            // Â∞ÜÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊ∂àÊÅØËΩ¨Êç¢‰∏∫ÂâçÁ´ØÊ∂àÊÅØÊ†ºÂºè
            const historyMessages = sortedData.map(msgPair => {
                // console.log('Â§ÑÁêÜÊ∂àÊÅØÂØπ:', msgPair);
                const messages = [];

                // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØ
                if (msgPair.userContent) {
                    messages.push({
                        id: `user_${msgPair.id}`,
                        sender: username.value,
                        content: msgPair.userContent,
                        time: new Date(msgPair.createTime).toLocaleTimeString(),
                        createTime: msgPair.createTime // ‰øùÂ≠òÂéüÂßãÊó∂Èó¥Áî®‰∫éÊéíÂ∫è
                    });
                }

                // Ê∑ªÂä†AIÂõûÂ§çÊ∂àÊÅØ
                if (msgPair.aiContent) {
                    messages.push({
                        id: `ai_${msgPair.id}`,
                        sender: 'AIÂä©Êâã',
                        content: msgPair.aiContent,
                        time: msgPair.responseTime ? new Date(msgPair.responseTime).toLocaleTimeString() : new Date(msgPair.createTime).toLocaleTimeString(),
                        createTime: msgPair.responseTime || msgPair.createTime // ‰øùÂ≠òÂéüÂßãÊó∂Èó¥Áî®‰∫éÊéíÂ∫è
                    });
                }

                return messages;
            }).flat();

            // console.log('ËΩ¨Êç¢ÂêéÁöÑÂéÜÂè≤Ê∂àÊÅØ:', historyMessages);
            messages.value = historyMessages;
        } else {
            console.error('Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÂ§±Ë¥•:', response.message);
            messages.value = [];
        }
    } catch (error) {
        console.error('Âä†ËΩΩÂéÜÂè≤Ê∂àÊÅØÂ§±Ë¥•:', error);
        messages.value = [];
    }
};

// ÂáÜÂ§áÊñ∞‰ºöËØùÁä∂ÊÄÅÔºà‰∏çÁ´ãÂç≥ÂàõÂª∫Ôºâ
const prepareNewConversation = () => {
    // ÂèñÊ∂àÂΩìÂâçÈÄâ‰∏≠ÁöÑ‰ºöËØù
    activeConversationId.value = null;
    // Ê∏ÖÁ©∫Ê∂àÊÅØÂàóË°®
    messages.value = [];
};

// ÂàõÂª∫Êñ∞‰ºöËØùÔºàÂÆûÈôÖÂàõÂª∫Ôºâ
const createNewConversation = async (firstQuestion = null) => {
    try {
        loading.value = true;
        const sessionData = {
            title: firstQuestion ? truncateTitle(firstQuestion) : `Êñ∞‰ºöËØù ${conversations.value.length + 1}`,
            isFavorite: 0,
            modelId: 1, // ÈªòËÆ§Ê®°ÂûãID
            tags: '',
            summary: ''
        };

        const response = await sessionApi.addSession(sessionData);
        if (response.code === 200) {
            const newId = response.data; // ÂêéÁ´ØËøîÂõûÊèíÂÖ•ÁöÑid
            const newConversation = {
                id: newId,
                title: sessionData.title,
                lastMessage: '',
                time: new Date(),
                messages: [],
                originalTitle: firstQuestion || sessionData.title,
                originalSummary: '',
                isFavorite: 0,
                tags: ''
            };

            conversations.value.unshift(newConversation);
            activeConversationId.value = newId;
            message.success('Â∑≤ÂàõÂª∫Êñ∞‰ºöËØù');
            return newId;
        } else {
            message.error(`ÂàõÂª∫‰ºöËØùÂ§±Ë¥•: ${response.message}`);
            return null;
        }
    } catch (error) {
        message.error(`ÂàõÂª∫‰ºöËØùÂ§±Ë¥•: ${error.message}`);
        return null;
    } finally {
        loading.value = false;
    }
};

// ‰ºöËØùÊìç‰ΩúËèúÂçï
const conversationOptions = [
    {
        label: 'ÈáçÂëΩÂêç',
        key: 'rename',
        icon: () => h(NIcon, null, { default: () => h(CreateOutline) })
    }
];

// Âà†Èô§‰ºöËØù
const deleteConversation = async (convId) => {
    try {
        loading.value = true;

        // Âà†Èô§‰ºöËØù
        const response = await sessionApi.deleteSession(convId);
        if (response.code === 200) {
            conversations.value = conversations.value.filter(conv => conv.id !== convId);
            if (activeConversationId.value === convId) {
                if (conversations.value.length > 0) {
                    switchConversation(conversations.value[0].id);
                } else {
                    activeConversationId.value = null;
                    messages.value = [];
                }
            }
            message.success('‰ºöËØùÂèäÁõ∏ÂÖ≥Ê∂àÊÅØÂ∑≤Âà†Èô§');
        } else {
            message.error(`Âà†Èô§‰ºöËØùÂ§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        message.error(`Âà†Èô§‰ºöËØùÂ§±Ë¥•: ${error.message}`);
    } finally {
        loading.value = false;
    }
};

// Â§ÑÁêÜ‰ºöËØùËèúÂçïÈÄâÊã©
const handleConversationAction = (key, convId) => {
    if (key === 'rename') {
        // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞ÈáçÂëΩÂêçÂäüËÉΩ
        message.info('ÈáçÂëΩÂêçÂäüËÉΩÂæÖÂÆûÁé∞');
    }
};

const sendMessage = async () => {
    if (!newMessage.value.trim()) return;

    try {
        // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©‰ºöËØùÔºåÂÖàÂàõÂª∫Êñ∞‰ºöËØù
        if (!activeConversationId.value) {
            const newSessionId = await createNewConversation(newMessage.value.trim());
            // Á≠âÂæÖ‰ºöËØùÂàõÂª∫ÂÆåÊàêÂêéÂÜçÂèëÈÄÅÊ∂àÊÅØ
            if (!newSessionId) {
                message.error('ÂàõÂª∫‰ºöËØùÂ§±Ë¥•ÔºåÊó†Ê≥ïÂèëÈÄÅÊ∂àÊÅØ');
                return;
            }
        }

        // Ê∑ªÂä†Áî®Êà∑Ê∂àÊÅØÂà∞ÂΩìÂâç‰ºöËØù
        const userMsg = {
            id: Date.now(),
            sender: username.value,
            content: newMessage.value.trim(),
            time: new Date().toLocaleTimeString()
        };
        messages.value.push(userMsg);

        // Á´ãÂç≥Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
        const messageContent = newMessage.value.trim();
        newMessage.value = '';

        // Êõ¥Êñ∞ÂΩìÂâç‰ºöËØùÁöÑÊúÄÂêéÊ∂àÊÅØÂíåÊó∂Èó¥
        const currentConv = conversations.value.find(conv => conv.id === activeConversationId.value);
        if (currentConv) {
            currentConv.lastMessage = userMsg.content;
            currentConv.time = new Date();
            currentConv.messages = [...messages.value];
        }

        // ÂèëÈÄÅÊ∂àÊÅØÂà∞ÂêéÁ´ØËé∑ÂèñsessionId
        const response = await chatApi.sendMessage({
            question: messageContent,
            sessionId: activeConversationId.value,
            modelId: 1, // TODO:Ê∑ªÂä†ÈªòËÆ§Ê®°ÂûãIDÔºåÂêéÁª≠‰øÆÊîπ‰∏∫ÂèØÈÄâÊã©
            conversationId: activeConversationId.value
        });

        console.log('ÂèëÈÄÅÊ∂àÊÅØAPIÂìçÂ∫î:', response); // Ê∑ªÂä†Ë∞ÉËØïÊó•Âøó

        if (response.code === 200) {
            const streamSessionId = response.data; // ÂêéÁ´ØËøîÂõûÁöÑsessionId
            console.log('Ëé∑ÂèñÂà∞streamSessionId:', streamSessionId); // Ë∞ÉËØïÊó•Âøó

            // ‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂà∞Êï∞ÊçÆÂ∫ì
            let messagePairId = null;
            try {
                const messageData = {
                    sessionId: activeConversationId.value,
                    sseSessionId: streamSessionId, // ‰ΩøÁî®Ëé∑ÂèñÂà∞ÁöÑSSE‰ºöËØùID
                    userContent: messageContent,
                    aiContent: '', // AIÂõûÂ§çÂÜÖÂÆπÊöÇÊó∂‰∏∫Á©∫
                    modelUsed: 1, // ÈªòËÆ§Ê®°ÂûãID
                    status: 0, // 0-ÁîüÊàê‰∏≠
                    tokens: 0, // ÊöÇÊó∂‰∏∫0
                    createTime: new Date(),
                    responseTime: null
                };

                const saveResponse = await messageApi.addMessage(messageData);
                if (saveResponse.code === 200) {
                    messagePairId = saveResponse.data; // ‰øùÂ≠òÊ∂àÊÅØÂØπID
                    console.log('Áî®Êà∑Ê∂àÊÅØÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºåÊ∂àÊÅØÂØπID:', messagePairId);
                } else {
                    console.error('‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂ§±Ë¥•:', saveResponse.message);
                }
            } catch (error) {
                console.error('‰øùÂ≠òÁî®Êà∑Ê∂àÊÅØÂ§±Ë¥•:', error);
            }

            // ÂàõÂª∫AIÊ∂àÊÅØÂç†‰ΩçÁ¨¶
            const aiMsg = {
                id: Date.now() + 1,
                sender: 'AIÂä©Êâã',
                content: '',
                time: new Date().toLocaleTimeString(),
                isStreaming: true
            };
            messages.value.push(aiMsg);

            // ËÆæÁΩÆÁîüÊàêÁä∂ÊÄÅ
            isGenerating.value = true;
            currentStreamSessionId.value = streamSessionId;
            
            // Âª∫Á´ãSSEËøûÊé•Ëé∑ÂèñÊµÅÂºèÂìçÂ∫î
            console.log('ÂáÜÂ§áÂª∫Á´ãSSEËøûÊé•...'); // Ë∞ÉËØïÊó•Âøó
            const eventSource = chatApi.createSSEConnection(streamSessionId);
            currentEventSource.value = eventSource;

            eventSource.onmessage = (event) => {
                try {
                    // console.log('Êé•Êî∂Âà∞SSEÊï∞ÊçÆ:', event.data); // Ë∞ÉËØïÊó•Âøó
                    // ÂêéÁ´ØÁõ¥Êé•ÂèëÈÄÅÊñáÊú¨ÂÜÖÂÆπÔºå‰∏çÊòØJSONÊ†ºÂºè
                    const text = event.data;
                    if (text && text.trim()) {
                        // console.log('Â§ÑÁêÜÊñáÊú¨ÂÜÖÂÆπ:', text); // Ë∞ÉËØïÊó•Âøó
                        // Á°Æ‰øùaiMsg.contentÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûãÔºåÁÑ∂ÂêéÁ¥ØÂä†ÂÜÖÂÆπ
                        aiMsg.content = (aiMsg.content || '') + text;
                        // Ëß¶ÂèëÂìçÂ∫îÂºèÊõ¥Êñ∞
                        messages.value = [...messages.value];
                        // ÊØèÊ¨°Êé•Êî∂Âà∞Êñ∞ÂÜÖÂÆπÊó∂ÊªöÂä®Âà∞Â∫ïÈÉ®
                        scrollToBottom();
                    }
                } catch (error) {
                    console.error('Â§ÑÁêÜSSEÊï∞ÊçÆÂ§±Ë¥•:', error, event);
                }
            };

            eventSource.onerror = (error) => {
                console.error('SSEËøûÊé•ÈîôËØØ:', error);
                aiMsg.isStreaming = false;
                isGenerating.value = false;
                currentEventSource.value = null;
                currentStreamSessionId.value = null;
                eventSource.close();

                // Â¶ÇÊûúÊ≤°ÊúâÊé•Êî∂Âà∞‰ªª‰ΩïÂÜÖÂÆπÔºåÊòæÁ§∫ÈîôËØØ‰ø°ÊÅØ
                if (!aiMsg.content) {
                    aiMsg.content = 'Êä±Ê≠âÔºåÊé•Êî∂Ê∂àÊÅØÊó∂Âá∫Áé∞ÈîôËØØÔºåËØ∑ÈáçËØï„ÄÇ';
                }
                // message.error('Êé•Êî∂Ê∂àÊÅØÊµÅÂ§±Ë¥•');
            };

            // ÁõëÂê¨ËøûÊé•ÊâìÂºÄ‰∫ã‰ª∂
            eventSource.onopen = () => {
                console.log('SSEËøûÊé•Â∑≤Âª∫Á´ã');
            };

            // ÁõëÂê¨ÊµÅÁªìÊùü‰∫ã‰ª∂
            eventSource.addEventListener('close', () => {
                console.log('SSEÊµÅÂ∑≤ÁªìÊùü');
                aiMsg.isStreaming = false;
                isGenerating.value = false;
                currentEventSource.value = null;
                currentStreamSessionId.value = null;
                eventSource.close();

                // Êõ¥Êñ∞‰ºöËØùÂàóË°®‰∏≠ÁöÑÊúÄÂêéÊ∂àÊÅØ
                if (currentConv && aiMsg.content) {
                    currentConv.lastMessage = aiMsg.content.substring(0, 20) + (aiMsg.content.length > 20 ? '...' : '');
                    currentConv.time = new Date();
                    currentConv.messages = [...messages.value];
                }

                console.log('AIÂõûÂ§çÂÆåÊàêÔºåÂêéÁ´Ø‰ºöËá™Âä®Êõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑAIÂõûÂ§çÂÜÖÂÆπ');
            });

            // ËÆæÁΩÆË∂ÖÊó∂Â§ÑÁêÜ
            setTimeout(() => {
                if (aiMsg.isStreaming && !aiMsg.content) {
                    console.warn('SSEËøûÊé•Ë∂ÖÊó∂ÔºåÊú™Êé•Êî∂Âà∞Êï∞ÊçÆ');
                    aiMsg.isStreaming = false;
                    isGenerating.value = false;
                    currentEventSource.value = null;
                    currentStreamSessionId.value = null;
                    aiMsg.content = 'ËøûÊé•Ë∂ÖÊó∂ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÈáçËØï„ÄÇ';
                    eventSource.close();
                    message.warning('ËøûÊé•Ë∂ÖÊó∂ÔºåËØ∑ÈáçËØï');
                }
            }, 30000); // 30ÁßíË∂ÖÊó∂

        } else {
            message.error(`ÂèëÈÄÅÂ§±Ë¥•: ${response.message}`);
            isGenerating.value = false;
            currentStreamSessionId.value = null;
        }
    } catch (error) {
        message.error(`ÂèëÈÄÅÂ§±Ë¥•: ${error.message}`);
        isGenerating.value = false;
        currentStreamSessionId.value = null;
    }

    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    newMessage.value = '';
};

// ÂÅúÊ≠¢AIÁîüÊàê
const stopGeneration = async () => {
    if (!currentStreamSessionId.value) {
        console.warn('Ê≤°ÊúâÊâæÂà∞ÂΩìÂâçÁöÑSSE‰ºöËØùID');
        return;
    }
    
    try {
        // Ë∞ÉÁî®ÂêéÁ´ØÂÅúÊ≠¢Êé•Âè£
        const response = await chatApi.stopGeneration(currentStreamSessionId.value);
        if (response.code === 200) {
            console.log('ÂÅúÊ≠¢ÁîüÊàêÊàêÂäü:', response.message);
        } else {
            console.error('ÂÅúÊ≠¢ÁîüÊàêÂ§±Ë¥•:', response.message);
            message.error(`ÂÅúÊ≠¢ÁîüÊàêÂ§±Ë¥•: ${response.message}`);
        }
    } catch (error) {
        console.error('Ë∞ÉÁî®ÂÅúÊ≠¢Êé•Âè£Â§±Ë¥•:', error);
        message.error(`ÂÅúÊ≠¢ÁîüÊàêÂ§±Ë¥•: ${error.message}`);
    }
    
    // ÂÖ≥Èó≠ÂâçÁ´ØSSEËøûÊé•
    if (currentEventSource.value) {
        currentEventSource.value.close();
        currentEventSource.value = null;
    }
    
    // ÊâæÂà∞Ê≠£Âú®ÁîüÊàêÁöÑAIÊ∂àÊÅØÂπ∂ÂÅúÊ≠¢ÊµÅÂºèÁä∂ÊÄÅ
    const lastMessage = messages.value[messages.value.length - 1];
    if (lastMessage && lastMessage.sender === 'AIÂä©Êâã' && lastMessage.isStreaming) {
        lastMessage.isStreaming = false;
        if (!lastMessage.content) {
            lastMessage.content = 'ÁîüÊàêÂ∑≤ÂÅúÊ≠¢„ÄÇ';
        }
    }
    
    // ÈáçÁΩÆÁä∂ÊÄÅ
    isGenerating.value = false;
    currentStreamSessionId.value = null;
    message.info('Â∑≤ÂÅúÊ≠¢ÁîüÊàê');
};



// Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ
const formatMessageContent = (content) => {
    if (!content) return '';

    // ËØ¶ÁªÜÁöÑÁ±ªÂûãÊ£ÄÊü•ÂíåË∞ÉËØï‰ø°ÊÅØ
    // console.log('formatMessageContent ËæìÂÖ•Á±ªÂûã:', typeof content, 'ÂÄº:', content);

    // Á°Æ‰øùcontentÊòØÂ≠óÁ¨¶‰∏≤Á±ªÂûã
    let contentStr;
    try {
        contentStr = typeof content === 'string' ? content : String(content);
    } catch (stringifyError) {
        console.error('Â≠óÁ¨¶‰∏≤ËΩ¨Êç¢Â§±Ë¥•:', stringifyError);
        return '';
    }

    try {
        // Â§ÑÁêÜÂêéÁ´ØËøîÂõûÁöÑHTMLËΩ¨‰πâÂ≠óÁ¨¶ÔºåËΩ¨Êç¢‰∏∫MarkdownÂèØËØÜÂà´ÁöÑÊ†ºÂºè
        let processedContent = contentStr
            // ÂÖàÂ§ÑÁêÜÊç¢Ë°åÁ¨¶ÔºöÂ∞Ü<br>ËΩ¨Êç¢‰∏∫ÁúüÊ≠£ÁöÑÊç¢Ë°åÁ¨¶
            .replace(/<br\s*\/?>/gi, '\n')
            // Â§ÑÁêÜÈùûÊñ≠Ë°åÁ©∫Ê†ºÔºöÂú®‰ª£Á†ÅÂùó‰∏≠‰øùÁïôÔºåÂú®ÊôÆÈÄöÊñáÊú¨‰∏≠ËΩ¨Êç¢‰∏∫ÊôÆÈÄöÁ©∫Ê†º
            .replace(/&nbsp;/g, ' ')
            // Â§ÑÁêÜÂÖ∂‰ªñHTMLËΩ¨‰πâÂ≠óÁ¨¶
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&')
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, "'");

        // ‰ΩøÁî®markedËß£ÊûêMarkdown
        // console.log('Ê†ºÂºèÂåñÊ∂àÊÅØÂÜÖÂÆπ:', processedContent);
        const marked = new Marked(
            markedHighlight({
                emptyLangClass: 'hljs',
                langPrefix: 'hljs language-',
                highlight(code, lang, info) {
                    const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                    return hljs.highlight(code, { language }).value;
                }
            })
        );
        const html = marked.parse(processedContent);
        // console.log('Ëß£ÊûêÂêéÊ∂àÊÅØÂÜÖÂÆπ:', html);

        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´‰ª£Á†ÅÂùó
        if (html.includes('<pre><code')) {
            console.log('Ê£ÄÊµãÂà∞‰ª£Á†ÅÂùóÔºåÂ∫îÁî®highlight.jsÊ†∑Âºè');
        }

        return html;
    } catch (error) {
        console.error('MarkdownËß£ÊûêÂ§±Ë¥•:', error, 'ËæìÂÖ•ÂÜÖÂÆπ:', contentStr);
        // ÈôçÁ∫ßÂà∞ÁÆÄÂçïÁöÑÊñáÊú¨ÊõøÊç¢
        try {
            const fallbackStr = typeof content === 'string' ? content : String(content);
            return fallbackStr
                .replace(/<br\s*\/?>/gi, '<br>')
                .replace(/&nbsp;/g, ' ')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&amp;/g, '&')
                .replace(/&quot;/g, '"')
                .replace(/&#39;/g, "'")
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        } catch (fallbackError) {
            console.error('ÈôçÁ∫ßÂ§ÑÁêÜ‰πüÂ§±Ë¥•:', fallbackError);
            return String(content || '');
        }
    }
};

// Ë∑≥ËΩ¨Âà∞ÈÖçÁΩÆÈ°µÈù¢
const goToConfig = () => {
    router.push('/config');
};

const logout = async () => {
    try {
        await userApi.logout();
        localStorage.removeItem('isLoggedIn');
        message.success('Â∑≤ÈÄÄÂá∫ÁôªÂΩï');
        router.push('/login');
    } catch (error) {
        message.error(`ÈîôËØØ:${error.message}`);
        return;
    }
};
</script>

<style scoped>
/* Ê†∑ÂºèÂ∑≤ÊèêÂèñÂà∞ assets/css/chat.css */
</style>